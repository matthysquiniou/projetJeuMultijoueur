#include "pch.h"

cpu_thread::cpu_thread()
{
	m_callback = nullptr;
	m_hThread = nullptr;
	m_idThread = 0;
	m_idThreadParent = 0;
	m_quitAsap = false;
}

cpu_thread::~cpu_thread()
{
	assert( IsRunning()==false );

	if ( m_idThread && m_hThread )
		TerminateThread(m_hThread, 0);

	if ( m_hThread )
		CloseHandle(m_hThread);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool cpu_thread::Run()
{
	assert( IsRunning()==false );

	DWORD idThread;
	HANDLE hThread = CreateThread(nullptr, 0, ThreadProc, (void*)this, CREATE_SUSPENDED, &idThread);
	if ( hThread==nullptr )
		return false;

	m_idThreadParent = GetCurrentThreadId();
	m_hThread = hThread;
	m_idThread = idThread;
	ResumeThread(m_hThread);
	return true;
}

bool cpu_thread::Run(const _METHOD& callback)
{
	m_callback = callback;
	return Run();
}

void cpu_thread::Wait()
{
	if ( m_hThread )
	{
		WaitForSingleObject(m_hThread, INFINITE);
		CloseHandle(m_hThread);
		m_hThread = nullptr;
		m_idThread = 0;
		m_idThreadParent = 0;
	}
}

void cpu_thread::QuitAsap()
{
	m_quitAsap = true;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DWORD WINAPI cpu_thread::ThreadProc(void* pParam)
{
	cpu_thread* pThread = (cpu_thread*)pParam;

	pThread->m_quitAsap = false;
	if ( pThread->m_callback!=nullptr )
		pThread->m_callback();
	else
		pThread->OnCallback();

	pThread->m_idThread = 0;
	return 0;
}
